schema text_chunk {
    document text_chunk {
        field id type string {
            indexing: attribute | summary
            attribute {
                fast-search
            }
        }
        field document_id type string {
            indexing: attribute | summary
            attribute {
                fast-search
            }
        }
        field access_group type string {
            indexing: summary | attribute
        }
        field chunk_text type string {
            indexing: summary | index
            index: enable-bm25
            match {
                text
            }
        }
        field chunking_strategy type string {
            indexing: summary | attribute
        }
        field chunk_no type int {
            indexing: summary | attribute
        }
        field last_updated type long {
            indexing: summary | attribute
        }
    }
    field embedding type tensor<bfloat16>(x[384]) {
        indexing: "passage: " . (input chunk_text || "") | embed e5 | attribute
        attribute {
            distance-metric: angular
        }
    }
    field colbert type tensor<int8>(dt{}, x[16]) {
        indexing: (input chunk_text || "") | embed colbert | attribute
    }

    rank-profile colbert {
        inputs {
            query(q) tensor<float>(x[384])             
            query(qt) tensor<float>(qt{}, x[128])             
        
        }
        function unpack() {
            expression {
                unpack_bits(attribute(colbert))
            }
        }
        function cos_sim() {
            expression {
                closeness(field, embedding)
            }
        }
        function max_sim() {
            expression {
                
                sum(
                    reduce(
                        sum(
                            query(qt) * unpack() , x
                        ),
                        max, dt
                    ),
                    qt
                )
                                
            }
        }
        first-phase {
            expression {
                cos_sim
            }
        }
        second-phase {
            rerank-count: 100
            expression {
                max_sim
            }
        }
        match-features {
            max_sim
            cos_sim
        }
    }

    rank-profile hybrid_search inherits default {
        inputs {
            query(q) tensor<float>(x[384])
            query(alpha) double
        }

        function keyword_score() {
            expression {
                bm25(chunk_text)
            }
        }

        function vector_score() {
            expression {
                closeness(field, embedding)
            }
        }

        first-phase {
            expression: vector_score
        }

        global-phase {
            expression {
                (query(alpha) * normalize_linear(vector_score)) +
                ((1 - query(alpha)) * normalize_linear(keyword_score))
            }
            rerank-count: 1000
        }

        match-features {
            bm25(chunk_text)
            closeness(field, embedding)
            vector_score
            keyword_score
        }
    }
}
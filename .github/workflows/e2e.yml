name: End-to-End Tests for Bridge
run-name: ${{ github.actor }} is running e2e tests for Bridge ðŸš€
on: 
    pull_request:
    workflow_dispatch:
    push:
        branches:
            - main

jobs:
    run-e2e-tests:
        runs-on: ubuntu-20.04
        environment: test
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Check if docker is installed
              run: docker --version

            - name: Check if docker-compose plugin is installed
              run: docker compose version

            - name: Check if Python is installed
              run: python --version

            - name: Install dotenv
              run: pip install python-dotenv

            - name: Create .env file with secrets
              run: |
                echo ELASTIC_PASSWORD=${{ secrets.ELASTIC_PASSWORD }} >> src/deployment/light/.env
                echo KIBANA_PASSWORD=${{ secrets.KIBANA_PASSWORD }} >> src/deployment/light/.env
                echo STACK_VERSION=${{ secrets.STACK_VERSION }} >> src/deployment/light/.env
                echo CLUSTER_NAME=${{ secrets.CLUSTER_NAME }} >> src/deployment/light/.env
                echo LICENSE=${{ secrets.LICENSE }} >> src/deployment/light/.env
                echo ES_PORT=${{ secrets.ES_PORT }} >> src/deployment/light/.env
                echo KIBANA_PORT=${{ secrets.KIBANA_PORT }} >> src/deployment/light/.env
                echo ES_MEM_LIMIT=${{ secrets.ES_MEM_LIMIT }} >> src/deployment/light/.env
                echo KB_MEM_LIMIT=${{ secrets.KB_MEM_LIMIT }} >> src/deployment/light/.env
                echo ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }} >> src/deployment/light/.env

            - name: Build api image
              run: docker build -t api src/backend

            - name: Navigate to the deployment directory and start the containers
              run: cd src/deployment/light && docker compose --profile ci up -d

            - name: List running containers for debugging
              run: docker ps

            - name: Wait for API to be healthy
              run: |
                echo "Waiting for API to be healthy..."
                until [ "`docker inspect -f {{.State.Health.Status}} light-api-1`" == "healthy" ]; do
                  docker ps;
                  sleep 5;
                done
            
            - name: Run e2e tests
              run: python src/deployment/light/e2e_tests/e2e_tests.py
              
            - name: Stop the containers
              run: cd src/deployment/light && docker compose down